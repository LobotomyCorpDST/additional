services:
  # --- MySQL Database Service ---
  db:
    image: mysql:8.0
    container_name: mysql-db
    environment:
      MYSQL_ROOT_PASSWORD: admin123
      MYSQL_DATABASE: apartment_db
      MYSQL_USER: appuser             # << เพิ่ม user ที่ไม่ใช่ root
      MYSQL_PASSWORD: apppass
    ports:
      - "3307:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- Spring Boot Backend Service ---
  backend:
    build: ./Backend
    container_name: my-backend-app
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: docker   # << บังคับใช้โปรไฟล์ docker
      SPRING_DATASOURCE_URL: "jdbc:mysql://db:3306/apartment_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC"
      SPRING_DATASOURCE_USERNAME: "appuser"
      SPRING_DATASOURCE_PASSWORD: "apppass"
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: "com.mysql.cj.jdbc.Driver"
    volumes:
      - uploads-data:/app/uploads
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  # --- React Frontend Service ---
  frontend:
    build:
      context: ./Frontend/app
    container_name: my-frontend-app
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_BASE=http://localhost:8080
      - CHOKIDAR_USEPOLLING=true
    volumes:
      # Mounts local source code into the container's /app directory
      - ./Frontend/app:/app
      - /app/node_modules
    depends_on:
      - backend
    restart: unless-stopped


volumes:
  mysql-data:
  uploads-data: